name: Build and Package App (uv)

on:
  push:
    branches:
      - main

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup uv and Python
        uses: astral-sh/setup-uv@v4
        with:
          python-version: '3.14'
          enable-cache: true
      - name: Install VLC and xcb dependencies
        run: sudo apt-get update && sudo apt-get install -y vlc libxcb-cursor0
      - name: Sync dependencies
        run: uv sync --frozen --dev
      - name: Package App with PyInstaller for Linux
        run: uv run pyinstaller qitv-linux.spec
      - name: Rename binary
        run: mv dist/qitv dist/qitv-linux
      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: packaged-app-linux
          path: dist/qitv-linux

  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup uv and Python
        uses: astral-sh/setup-uv@v4
        with:
          python-version: '3.14'
          enable-cache: true
      - name: Get latest VLC version
        id: vlc-version
        shell: powershell
        run: |
          $info = choco info vlc --limit-output
          $version = ($info -split '\|')[1]
          echo "version=$version" >> $env:GITHUB_OUTPUT
      - name: Cache VLC installer
        id: vlc-cache
        uses: actions/cache@v4
        with:
          path: C:\vlc-cache
          key: vlc-windows-${{ steps.vlc-version.outputs.version }}
      - name: Install VLC using Chocolatey
        run: choco install vlc -y --cache-location=C:\vlc-cache
      - name: Sync dependencies
        run: uv sync --frozen --dev
      - name: Package App with PyInstaller for Windows
        run: uv run pyinstaller qitv-windows.spec
      - name: Rename binary
        run: ren dist\qitv.exe qitv-windows.exe
      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: packaged-app-windows
          path: dist/qitv-windows.exe

  build-macos-universal:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup uv and Python
        uses: astral-sh/setup-uv@v4
        with:
          python-version: '3.14'
          enable-cache: true
      - name: Get latest VLC version
        id: vlc-version
        run: |
          VLC_VERSION=$(brew info --json=v2 --cask vlc | python3 -c "import sys,json; print(json.load(sys.stdin)['casks'][0]['version'])")
          echo "version=$VLC_VERSION" >> $GITHUB_OUTPUT
      - name: Cache VLC.app
        id: vlc-cache
        uses: actions/cache@v4
        with:
          path: /Applications/VLC.app
          key: vlc-macos-arm64-${{ steps.vlc-version.outputs.version }}
      - name: Install VLC
        if: steps.vlc-cache.outputs.cache-hit != 'true'
        run: brew install --cask vlc
      - name: Sync dependencies
        run: uv sync --frozen --dev
      - name: Package App with PyInstaller for macOS
        run: uv run pyinstaller qitv-macos.spec
      - name: Ad-Hoc Sign the app
        run: codesign --force --deep --sign - dist/qitv.app
      - name: Zip macOS App
        run: cd dist && zip -r qitv-macos-universal.zip qitv.app
      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: packaged-app-macos-universal
          path: dist/qitv-macos-universal.zip

  build-macos-intel:
    runs-on: macos-15-intel
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Setup uv and Python
        uses: astral-sh/setup-uv@v4
        with:
          python-version: '3.14'
          enable-cache: true
      - name: Get latest VLC version
        id: vlc-version
        run: |
          VLC_VERSION=$(brew info --json=v2 --cask vlc | python3 -c "import sys,json; print(json.load(sys.stdin)['casks'][0]['version'])")
          echo "version=$VLC_VERSION" >> $GITHUB_OUTPUT
      - name: Cache VLC.app
        id: vlc-cache
        uses: actions/cache@v4
        with:
          path: /Applications/VLC.app
          key: vlc-macos-intel-${{ steps.vlc-version.outputs.version }}
      - name: Install VLC
        if: steps.vlc-cache.outputs.cache-hit != 'true'
        run: brew install --cask vlc
      - name: Sync dependencies
        run: uv sync --frozen --dev
      - name: Package App with PyInstaller for macOS (Intel)
        run: uv run pyinstaller qitv-macos.spec
      - name: Ad-Hoc Sign the app
        run: codesign --force --deep --sign - dist/qitv.app
      - name: Zip macOS App
        run: cd dist && zip -r qitv-macos-intel.zip qitv.app
      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: packaged-app-macos-intel
          path: dist/qitv-macos-intel.zip

  release:
    needs: [build-linux, build-windows, build-macos-universal, build-macos-intel]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Get Version
        id: get_version
        run: |
          version=$(python3 -c "
          import tomllib
          with open('pyproject.toml','rb') as f:
              print(tomllib.load(f)['project']['version'])
          ")
          echo "VERSION=$version" >> $GITHUB_ENV
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: v${{ env.VERSION }}
          body: |
            > **Please always download this free software from [Releases](https://github.com/ozankaraali/QiTV/releases) instead of using others' distributions, which may have malware. Always keep the [original repository](https://github.com/ozankaraali/QiTV) as reference.**
          generate_release_notes: true
          draft: false
          prerelease: true
          files: |
            packaged-app-linux/qitv-linux
            packaged-app-windows/qitv-windows.exe
            packaged-app-macos-universal/qitv-macos-universal.zip
            packaged-app-macos-intel/qitv-macos-intel.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
